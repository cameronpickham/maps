// Generated by CoffeeScript 1.6.3
(function() {
  var map, mapOptions, plot, popups, voronoiOverlay;

  plot = function(place) {
    var infoWindow, latLng, marker;
    latLng = place.latLng;
    infoWindow = new google.maps.InfoWindow({
      content: "" + place.name + " | " + place.count,
      state: 'closed'
    });
    marker = new google.maps.Marker({
      map: map,
      position: new google.maps.LatLng(latLng[0], latLng[1])
    });
    google.maps.event.addListener(marker, 'mouseover', function() {
      if (infoWindow.state !== 'zoom_open') {
        infoWindow.state = 'mouseover_open';
        return infoWindow.open(map, marker);
      }
    });
    google.maps.event.addListener(marker, 'mouseout', function() {
      if (infoWindow.state !== 'zoom_open') {
        infoWindow.state = 'closed';
        return infoWindow.close();
      }
    });
    google.maps.event.addListener(marker, 'click', function() {
      infoWindow.state = 'closed';
      return infoWindow.close();
    });
    return popups["" + latLng[0] + latLng[1]] = {
      marker: marker,
      infoWindow: infoWindow
    };
  };

  mapOptions = {
    zoom: 12,
    center: new google.maps.LatLng(34.02234, -118.28512),
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    disableDefaultUI: true
  };

  map = new google.maps.Map(d3.select("#map-canvas").node(), mapOptions);

  voronoiOverlay = null;

  popups = {};

  $.getJSON("./checkins.json", function(data) {
    google.maps.event.addDomListener(window, "load", (function() {
      var place, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        place = data[_i];
        _results.push(plot(place));
      }
      return _results;
    })());
    return voronoiOverlay = new App.Overlay(map, data);
  });

  $("#recent").click(function() {
    return $("#menu").collapse('toggle');
  });

  $(".recent").click(function(event) {
    var clickedId, ele, infoWindow, latLng, marker, vals, _ref;
    clickedId = $(this).attr("id").substring(3);
    ele = $("body").find('#' + "input-" + clickedId);
    vals = ele.val().split(/[, ]+/);
    latLng = vals.map(function(v) {
      return parseFloat(v);
    });
    map.setCenter(new google.maps.LatLng(latLng[0], latLng[1]));
    map.setZoom(16);
    _ref = popups["" + latLng[0] + latLng[1]], marker = _ref.marker, infoWindow = _ref.infoWindow;
    infoWindow.state = 'zoom_open';
    infoWindow.open(map, marker);
    return $("#menu").collapse('toggle');
  });

  $("#close").click(function() {
    return $("#menu").collapse('toggle');
  });

  $("#overlay-toggle").click(function(event) {
    return voronoiOverlay.toggleDOM();
  });

}).call(this);
